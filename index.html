<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bear Stars">
    <meta name="theme-color" content="#4a90d9">
    <title>Paul's Bear Stars</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'><rect width='200' height='200' rx='40' fill='%234a90d9'/><text x='100' y='130' font-size='120' text-anchor='middle'>&#x1F9F8;</text></svg>">
    <style>
        *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        :root {
            --bg-primary:#FFF8E7; --bg-secondary:#FFE4B5; --accent-blue:#4a90d9;
            --accent-green:#5cb85c; --accent-red:#e74c3c; --accent-orange:#f39c12;
            --accent-purple:#9b59b6; --accent-pink:#e91e8a; --star-gold:#FFD700;
            --bear-brown:#8B5E3C; --bear-light:#D2A679; --bear-dark:#6B4226;
            --text-dark:#3a2a1a; --text-medium:#6b5a4a;
            --card-shadow:0 4px 15px rgba(0,0,0,0.1);
            --safe-top:env(safe-area-inset-top,20px); --safe-bottom:env(safe-area-inset-bottom,0px);
        }
        html,body { height:100%; overflow:hidden; font-family:-apple-system,BlinkMacSystemFont,'SF Pro Rounded','Segoe UI',Roboto,sans-serif; background:var(--bg-primary); color:var(--text-dark); user-select:none; -webkit-user-select:none; }
        body { padding-top:var(--safe-top); padding-bottom:var(--safe-bottom); }

        /* Views */
        .view { display:none; height:100%; width:100%; position:absolute; top:0; left:0; }
        .view.active { display:flex; flex-direction:column; }

        /* Main View */
        #mainView { background:linear-gradient(180deg,#87CEEB 0%,#B0E0FF 30%,var(--bg-primary) 30%); }
        .header { text-align:center; padding:calc(var(--safe-top)+10px) 16px 6px; position:relative; flex-shrink:0; }

        /* Bear */
        .bear-container { position:relative; width:90px; height:100px; margin:0 auto 4px; }
        .bear { position:relative; width:100%; height:100%; }
        .bear-ear { position:absolute; width:30px; height:30px; background:var(--bear-brown); border-radius:50%; top:0; }
        .bear-ear::after { content:''; position:absolute; width:16px; height:16px; background:var(--bear-light); border-radius:50%; top:50%; left:50%; transform:translate(-50%,-50%); }
        .bear-ear.left { left:8px; } .bear-ear.right { right:8px; }
        .bear-face { position:absolute; width:72px; height:70px; background:var(--bear-brown); border-radius:50%; top:16px; left:50%; transform:translateX(-50%); box-shadow:inset -4px -4px 8px rgba(0,0,0,0.15); }
        .bear-inner-face { position:absolute; width:46px; height:34px; background:var(--bear-light); border-radius:50%; bottom:8px; left:50%; transform:translateX(-50%); }
        .bear-eye { position:absolute; width:9px; height:11px; background:#2c1810; border-radius:50%; top:26px; }
        .bear-eye::after { content:''; position:absolute; width:3px; height:3px; background:white; border-radius:50%; top:2px; left:2px; }
        .bear-eye.left { left:18px; } .bear-eye.right { right:18px; }
        .bear-nose { position:absolute; width:12px; height:9px; background:#2c1810; border-radius:50%; top:38px; left:50%; transform:translateX(-50%); }
        .bear-mouth { position:absolute; width:22px; height:9px; border:2px solid #2c1810; border-top:none; border-radius:0 0 50% 50%; top:45px; left:50%; transform:translateX(-50%); }
        .bear-blush { position:absolute; width:12px; height:7px; background:rgba(255,150,150,0.5); border-radius:50%; top:36px; }
        .bear-blush.left { left:8px; } .bear-blush.right { right:8px; }
        .bear-container.celebrating .bear { animation:bearBounce 0.4s ease infinite; }
        @keyframes bearBounce { 0%,100%{transform:translateY(0) rotate(0)} 25%{transform:translateY(-8px) rotate(-3deg)} 75%{transform:translateY(-8px) rotate(3deg)} }

        .child-name { font-size:20px; font-weight:800; color:var(--text-dark); margin-bottom:2px; }

        /* Streak */
        .streak-badge { display:inline-flex; align-items:center; gap:4px; background:#fff3e0; padding:2px 10px; border-radius:12px; font-size:12px; font-weight:700; color:var(--accent-orange); margin-bottom:4px; }
        .streak-badge .streak-fire { font-size:14px; }

        /* Star Counter */
        .star-counter { display:flex; align-items:center; justify-content:center; gap:6px; background:white; padding:6px 20px; border-radius:30px; box-shadow:var(--card-shadow); margin:0 auto; width:fit-content; }
        .star-icon { font-size:24px; animation:starPulse 2s ease infinite; }
        @keyframes starPulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.1)} }
        .star-count { font-size:22px; font-weight:800; } .star-target { font-size:14px; color:var(--text-medium); font-weight:600; }

        /* Progress */
        .progress-container { margin:6px 24px 4px; flex-shrink:0; }
        .progress-bar { height:14px; background:#e0d5c5; border-radius:10px; overflow:hidden; box-shadow:inset 0 2px 4px rgba(0,0,0,0.1); }
        .progress-fill { height:100%; background:linear-gradient(90deg,var(--star-gold),#FFA500); border-radius:10px; transition:width 0.5s cubic-bezier(0.34,1.56,0.64,1); position:relative; }
        .progress-fill::after { content:''; position:absolute; top:2px; left:4px; right:4px; height:3px; background:rgba(255,255,255,0.4); border-radius:4px; }
        .progress-label { text-align:center; font-size:12px; font-weight:700; color:var(--text-medium); margin-top:3px; }

        /* Reward badge */
        .current-reward-badge { display:flex; align-items:center; justify-content:center; gap:5px; margin:4px auto 0; cursor:pointer; background:white; padding:4px 14px; border-radius:20px; box-shadow:0 2px 8px rgba(0,0,0,0.08); border:2px solid var(--star-gold); width:fit-content; }
        .current-reward-badge .badge-emoji { font-size:18px; } .current-reward-badge .badge-label { font-size:12px; font-weight:700; }
        .current-reward-badge .badge-change { font-size:10px; color:var(--accent-blue); font-weight:700; }

        /* Category headers */
        .category-header { font-size:13px; font-weight:800; color:white; padding:6px 16px; margin:8px 0 4px; border-radius:10px; display:flex; align-items:center; gap:6px; }
        .category-header.morning { background:linear-gradient(135deg,#f39c12,#e67e22); }
        .category-header.afternoon { background:linear-gradient(135deg,#3498db,#2980b9); }
        .category-header.evening { background:linear-gradient(135deg,#8e44ad,#6c3483); }

        /* Section label */
        .section-label { font-size:13px; font-weight:700; color:var(--text-medium); padding:4px 24px 2px; flex-shrink:0; }

        /* Task Grid */
        .task-grid-wrapper { flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch; padding:2px 12px calc(70px + var(--safe-bottom)); }
        .task-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; padding-bottom:10px; }

        /* Task Card */
        .task-card { background:white; border-radius:16px; padding:10px 4px; text-align:center; box-shadow:var(--card-shadow); cursor:pointer; transition:transform 0.15s ease; position:relative; overflow:hidden; border:3px solid transparent; min-height:90px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:2px; }
        .task-card:active { transform:scale(0.93); }
        .task-card.completed { background:#E8F5E9; border-color:var(--accent-green); }
        .task-card.completed .task-emoji { opacity:0.6; }
        .task-card .task-emoji { font-size:34px; line-height:1.1; }
        .task-card .task-label { font-size:10px; font-weight:700; color:var(--text-dark); line-height:1.2; max-width:100%; overflow:hidden; }
        .task-card .task-points { font-size:9px; color:var(--star-gold); font-weight:700; }
        .task-card .task-check { position:absolute; top:4px; right:4px; width:20px; height:20px; border-radius:50%; background:var(--accent-green); display:none; align-items:center; justify-content:center; color:white; font-size:12px; font-weight:bold; }
        .task-card.completed .task-check { display:flex; }

        /* Bottom Bar */
        .bottom-bar { position:fixed; bottom:0; left:0; right:0; display:flex; justify-content:space-between; align-items:center; padding:8px 16px calc(8px + var(--safe-bottom)); background:white; box-shadow:0 -2px 10px rgba(0,0,0,0.1); z-index:10; }
        .bottom-btn { display:flex; flex-direction:column; align-items:center; gap:1px; background:none; border:none; font-size:10px; font-weight:600; color:var(--text-medium); cursor:pointer; padding:4px 10px; }
        .bottom-btn .btn-icon { font-size:22px; }
        .reset-today-btn { background:var(--accent-blue); color:white; border:none; border-radius:25px; padding:8px 20px; font-size:14px; font-weight:700; cursor:pointer; box-shadow:0 3px 10px rgba(74,144,217,0.3); }
        .reset-today-btn:active { transform:scale(0.95); }

        /* Star overlay */
        .star-overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.4); z-index:100; justify-content:center; align-items:center; flex-direction:column; }
        .star-overlay.active { display:flex; }
        .star-popup { background:white; border-radius:30px; padding:24px; text-align:center; animation:popIn 0.3s cubic-bezier(0.34,1.56,0.64,1); box-shadow:0 10px 40px rgba(0,0,0,0.2); }
        @keyframes popIn { 0%{transform:scale(0);opacity:0} 100%{transform:scale(1);opacity:1} }
        .star-popup .big-star { font-size:70px; animation:starSpin 0.6s ease; }
        @keyframes starSpin { 0%{transform:scale(0) rotate(-180deg)} 60%{transform:scale(1.3) rotate(10deg)} 100%{transform:scale(1) rotate(0)} }
        .star-popup .popup-text { font-size:20px; font-weight:800; margin-top:8px; }
        .star-popup .popup-subtext { font-size:14px; color:var(--text-medium); margin-top:4px; font-weight:600; }

        /* Celebration */
        #celebrationView { background:linear-gradient(180deg,#1a0533,#2d1b69,#4a2c8a); align-items:center; justify-content:center; text-align:center; z-index:50; }
        .celebration-content { z-index:2; padding:20px; }
        .celebration-emoji { font-size:70px; animation:celebBounce 0.5s ease infinite; margin-bottom:16px; }
        @keyframes celebBounce { 0%,100%{transform:translateY(0) scale(1)} 50%{transform:translateY(-20px) scale(1.1)} }
        .celebration-title { font-size:30px; font-weight:900; color:var(--star-gold); text-shadow:0 2px 10px rgba(255,215,0,0.5); margin-bottom:8px; }
        .celebration-subtitle { font-size:18px; color:white; font-weight:600; margin-bottom:6px; }
        .celebration-reward { font-size:56px; margin:16px 0; animation:rewardPulse 1s ease infinite; }
        @keyframes rewardPulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.2)} }
        .celebration-message { font-size:16px; color:#ccc; margin-bottom:24px; font-weight:600; }
        .claim-btn { background:linear-gradient(135deg,var(--star-gold),#FFA500); color:var(--text-dark); border:none; border-radius:30px; padding:14px 36px; font-size:18px; font-weight:800; cursor:pointer; box-shadow:0 5px 20px rgba(255,215,0,0.4); animation:claimPulse 2s ease infinite; }
        @keyframes claimPulse { 0%,100%{box-shadow:0 5px 20px rgba(255,215,0,0.4)} 50%{box-shadow:0 5px 30px rgba(255,215,0,0.7)} }
        .claim-btn:active { transform:scale(0.95); }
        .confetti-canvas { position:absolute; top:0; left:0; width:100%; height:100%; z-index:1; pointer-events:none; }
        .celebration-stars { display:flex; justify-content:center; gap:4px; margin-bottom:8px; }
        .celebration-stars span { font-size:22px; animation:starTwinkle 1s ease infinite; }
        .celebration-stars span:nth-child(2){animation-delay:0.2s} .celebration-stars span:nth-child(3){animation-delay:0.4s} .celebration-stars span:nth-child(4){animation-delay:0.6s} .celebration-stars span:nth-child(5){animation-delay:0.8s}
        @keyframes starTwinkle { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.5;transform:scale(0.7)} }

        /* Reward picker */
        #rewardPickerView { background:linear-gradient(180deg,#FFE4B5 0%,var(--bg-primary) 100%); align-items:center; text-align:center; }
        .reward-picker-content { padding:20px; width:100%; max-width:500px; flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch; }
        .reward-picker-bear { font-size:50px; margin-bottom:4px; margin-top:calc(var(--safe-top) + 10px); }
        .reward-picker-title { font-size:22px; font-weight:900; margin-bottom:4px; }
        .reward-picker-subtitle { font-size:14px; font-weight:600; color:var(--text-medium); margin-bottom:16px; }
        .reward-options { display:flex; flex-direction:column; gap:10px; padding-bottom:20px; }
        .reward-option { display:flex; align-items:center; gap:12px; background:white; border:3px solid transparent; border-radius:18px; padding:12px 16px; cursor:pointer; box-shadow:var(--card-shadow); transition:transform 0.15s ease,border-color 0.15s ease; text-align:left; }
        .reward-option:active { transform:scale(0.96); }
        .reward-option.selected { border-color:var(--star-gold); background:#FFFDF0; }
        .reward-option-emoji { font-size:36px; flex-shrink:0; width:44px; text-align:center; }
        .reward-option-info { flex:1; }
        .reward-option-name { font-size:16px; font-weight:800; } .reward-option-desc { font-size:11px; color:var(--text-medium); font-weight:600; }

        /* Settings */
        #settingsView { background:var(--bg-primary); z-index:40; }
        .settings-header { display:flex; align-items:center; justify-content:space-between; padding:calc(var(--safe-top)+12px) 16px 12px; background:white; box-shadow:0 2px 8px rgba(0,0,0,0.08); flex-shrink:0; }
        .settings-title { font-size:18px; font-weight:800; }
        .settings-close-btn { background:#eee; border:none; width:34px; height:34px; border-radius:50%; font-size:16px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
        .settings-scroll { flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch; padding:12px; padding-bottom:calc(20px + var(--safe-bottom)); }
        .settings-section { background:white; border-radius:14px; padding:14px; margin-bottom:12px; box-shadow:var(--card-shadow); }
        .settings-section-title { font-size:15px; font-weight:800; margin-bottom:10px; display:flex; align-items:center; gap:6px; }
        .settings-section-title .icon { font-size:18px; }

        .threshold-display { text-align:center; margin-bottom:10px; }
        .threshold-value { font-size:32px; font-weight:900; color:var(--accent-blue); }
        .threshold-label { font-size:13px; color:var(--text-medium); font-weight:600; }
        .threshold-slider { width:100%; height:8px; -webkit-appearance:none; appearance:none; background:#e0d5c5; border-radius:4px; outline:none; }
        .threshold-slider::-webkit-slider-thumb { -webkit-appearance:none; appearance:none; width:30px; height:30px; border-radius:50%; background:var(--accent-blue); cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.2); }

        .toggle-row { display:flex; justify-content:space-between; align-items:center; padding:6px 0; }
        .toggle-label { font-size:14px; font-weight:600; }
        .toggle-switch { position:relative; width:50px; height:28px; background:#ccc; border-radius:14px; cursor:pointer; transition:background 0.3s; border:none; }
        .toggle-switch.on { background:var(--accent-green); }
        .toggle-switch::after { content:''; position:absolute; width:24px; height:24px; background:white; border-radius:50%; top:2px; left:2px; transition:transform 0.3s; box-shadow:0 1px 3px rgba(0,0,0,0.2); }
        .toggle-switch.on::after { transform:translateX(22px); }

        .task-list-manage { max-height:250px; overflow-y:auto; }
        .task-manage-item { display:flex; align-items:center; gap:8px; padding:6px 2px; border-bottom:1px solid #f0e8d8; }
        .task-manage-item:last-child { border-bottom:none; }
        .task-manage-emoji { font-size:22px; width:30px; text-align:center; cursor:pointer; }
        .task-manage-label { flex:1; font-size:13px; font-weight:600; }
        .task-manage-points { font-size:11px; font-weight:700; color:var(--star-gold); width:30px; text-align:center; }
        .task-manage-cat { font-size:9px; font-weight:600; color:var(--accent-blue); width:50px; text-align:center; }
        .task-manage-delete { background:var(--accent-red); color:white; border:none; width:26px; height:26px; border-radius:50%; font-size:14px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; }

        .add-task-form { display:flex; gap:6px; margin-top:10px; flex-wrap:wrap; align-items:center; }
        .add-task-form input, .add-task-form select { padding:8px 10px; border:2px solid #e0d5c5; border-radius:10px; font-size:14px; font-family:inherit; outline:none; }
        .add-task-form input:focus, .add-task-form select:focus { border-color:var(--accent-blue); }
        .emoji-input { width:50px!important; text-align:center; font-size:20px!important; flex:none!important; cursor:pointer; }
        .name-input { flex:1; min-width:0; }
        .points-select { width:60px; }
        .cat-select { width:90px; font-size:12px; }
        .add-task-btn { background:var(--accent-green); color:white; border:none; border-radius:10px; padding:8px 14px; font-size:14px; font-weight:700; cursor:pointer; }
        .add-task-btn:active { transform:scale(0.95); }

        /* Reward management */
        .reward-manage-item { display:flex; align-items:center; gap:8px; padding:6px 2px; border-bottom:1px solid #f0e8d8; }
        .reward-manage-item:last-child { border-bottom:none; }
        .reward-manage-emoji { font-size:22px; width:30px; text-align:center; cursor:pointer; }
        .reward-manage-label { flex:1; font-size:13px; font-weight:600; }
        .reward-manage-delete { background:var(--accent-red); color:white; border:none; width:26px; height:26px; border-radius:50%; font-size:14px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
        .add-reward-form { display:flex; gap:6px; margin-top:10px; align-items:center; }

        .reset-btn { width:100%; padding:10px; border:none; border-radius:10px; font-size:14px; font-weight:700; cursor:pointer; margin-bottom:6px; }
        .reset-btn:last-child { margin-bottom:0; }
        .reset-btn.warning { background:var(--accent-orange); color:white; }
        .reset-btn.danger { background:var(--accent-red); color:white; }
        .reset-btn:active { transform:scale(0.97); }

        /* Parent gate */
        .parent-gate-overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:90; justify-content:center; align-items:center; }
        .parent-gate-overlay.active { display:flex; }
        .parent-gate-box { background:white; border-radius:24px; padding:24px; text-align:center; max-width:280px; width:90%; }
        .parent-gate-title { font-size:16px; font-weight:800; margin-bottom:6px; }
        .parent-gate-subtitle { font-size:13px; color:var(--text-medium); margin-bottom:16px; }
        .hold-button { width:90px; height:90px; border-radius:50%; border:4px solid #e0d5c5; background:white; cursor:pointer; position:relative; margin:0 auto 12px; display:flex; align-items:center; justify-content:center; font-size:32px; }
        .hold-progress { position:absolute; top:-4px; left:-4px; width:98px; height:98px; }
        .hold-progress circle { fill:none; stroke-width:4; stroke-linecap:round; transform:rotate(-90deg); transform-origin:center; }
        .hold-progress .bg { stroke:#e0d5c5; } .hold-progress .fg { stroke:var(--accent-blue); stroke-dasharray:282; stroke-dashoffset:282; transition:none; }
        .parent-gate-cancel { background:none; border:none; color:var(--text-medium); font-size:14px; font-weight:600; cursor:pointer; padding:6px; }

        /* Undo toast */
        .undo-toast { display:none; position:fixed; bottom:calc(75px + var(--safe-bottom)); left:50%; transform:translateX(-50%); background:#333; color:white; padding:8px 16px; border-radius:20px; font-size:13px; font-weight:600; z-index:80; align-items:center; gap:10px; box-shadow:0 4px 15px rgba(0,0,0,0.3); white-space:nowrap; }
        .undo-toast.active { display:flex; animation:slideUp 0.3s ease; }
        @keyframes slideUp { from{transform:translateX(-50%) translateY(20px);opacity:0} to{transform:translateX(-50%) translateY(0);opacity:1} }
        .undo-btn { background:var(--accent-blue); color:white; border:none; border-radius:12px; padding:3px 12px; font-size:12px; font-weight:700; cursor:pointer; }

        /* History */
        #historyView { background:var(--bg-primary); }
        .history-header { display:flex; align-items:center; justify-content:space-between; padding:calc(var(--safe-top)+12px) 16px 12px; background:white; box-shadow:0 2px 8px rgba(0,0,0,0.08); flex-shrink:0; }
        .history-title { font-size:18px; font-weight:800; }
        .history-close-btn { background:#eee; border:none; width:34px; height:34px; border-radius:50%; font-size:16px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
        .history-scroll { flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch; padding:12px; padding-bottom:calc(20px + var(--safe-bottom)); }
        .history-stat { background:white; border-radius:14px; padding:16px; text-align:center; margin-bottom:12px; box-shadow:var(--card-shadow); }
        .history-stat-number { font-size:42px; font-weight:900; color:var(--accent-blue); }
        .history-stat-label { font-size:13px; font-weight:600; color:var(--text-medium); }
        .history-rewards { display:flex; gap:10px; }
        .history-rewards .history-stat { flex:1; }

        /* Emoji Picker Modal */
        .emoji-picker-overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:200; justify-content:center; align-items:flex-end; }
        .emoji-picker-overlay.active { display:flex; }
        .emoji-picker { background:white; border-radius:20px 20px 0 0; width:100%; max-width:500px; max-height:60vh; display:flex; flex-direction:column; animation:slideUpPicker 0.3s ease; }
        @keyframes slideUpPicker { from{transform:translateY(100%)} to{transform:translateY(0)} }
        .emoji-picker-header { display:flex; justify-content:space-between; align-items:center; padding:12px 16px 8px; border-bottom:1px solid #eee; flex-shrink:0; }
        .emoji-picker-header-title { font-size:16px; font-weight:800; }
        .emoji-picker-close { background:#eee; border:none; width:30px; height:30px; border-radius:50%; font-size:14px; cursor:pointer; }
        .emoji-categories { display:flex; gap:2px; padding:6px 12px; overflow-x:auto; flex-shrink:0; -webkit-overflow-scrolling:touch; }
        .emoji-cat-btn { background:none; border:none; padding:4px 8px; font-size:20px; cursor:pointer; border-radius:8px; flex-shrink:0; }
        .emoji-cat-btn.active { background:#e8f0fe; }
        .emoji-grid { display:grid; grid-template-columns:repeat(8,1fr); gap:2px; padding:8px 12px; overflow-y:auto; -webkit-overflow-scrolling:touch; flex:1; }
        .emoji-grid-item { font-size:26px; text-align:center; padding:6px; cursor:pointer; border-radius:8px; }
        .emoji-grid-item:active { background:#e8f0fe; }

        /* Responsive */
        @media (min-width:768px) {
            .task-grid { grid-template-columns:repeat(4,1fr); gap:12px; max-width:700px; margin:0 auto; }
            .task-card { min-height:110px; padding:14px 6px; } .task-card .task-emoji { font-size:44px; } .task-card .task-label { font-size:12px; }
            .bear-container { width:110px; height:120px; }
            .emoji-grid { grid-template-columns:repeat(10,1fr); }
        }
        @media (max-width:374px) { .task-grid { grid-template-columns:repeat(2,1fr); } .task-card .task-emoji { font-size:30px; } }
        @media (orientation:landscape) and (max-height:500px) { .header { padding-top:6px; padding-bottom:2px; } .bear-container { width:50px; height:60px; margin-bottom:2px; } .child-name{font-size:14px} .star-counter{padding:3px 12px} .star-icon{font-size:18px} .star-count{font-size:18px} .progress-container{margin:2px 24px} .progress-bar{height:8px} }
    </style>
</head>
<body>
    <!-- MAIN VIEW -->
    <div id="mainView" class="view active">
        <div class="header">
            <div class="bear-container" id="bearAvatar"><div class="bear"><div class="bear-ear left"></div><div class="bear-ear right"></div><div class="bear-face"><div class="bear-eye left"></div><div class="bear-eye right"></div><div class="bear-blush left"></div><div class="bear-blush right"></div><div class="bear-inner-face"></div><div class="bear-nose"></div><div class="bear-mouth"></div></div></div></div>
            <div class="child-name">Paul's Stars</div>
            <div class="streak-badge" id="streakBadge" style="display:none"><span class="streak-fire">&#128293;</span> <span id="streakCount">0</span> day streak!</div>
            <div class="star-counter"><span class="star-icon">&#11088;</span><span class="star-count" id="starCount">0</span><span class="star-target" id="starTarget">/ 30</span></div>
        </div>
        <div class="progress-container"><div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div><div class="progress-label"><span id="progressText">0 more stars to earn</span> <span id="progressRewardIcon">&#127851;</span></div></div>
        <div class="current-reward-badge" id="rewardBadge" onclick="showRewardPicker()"><span class="badge-emoji" id="badgeEmoji">&#127851;</span><span class="badge-label" id="badgeLabel">Chocolate</span><span class="badge-change">change</span></div>
        <div class="section-label">Tap a task when Paul completes it!</div>
        <div class="task-grid-wrapper"><div id="taskGridContainer"></div></div>
        <div class="bottom-bar">
            <button class="bottom-btn" onclick="showHistory()"><span class="btn-icon">&#127942;</span><span>Rewards</span></button>
            <button class="reset-today-btn" onclick="resetToday()">New Day</button>
            <button class="bottom-btn" onclick="showParentGate()"><span class="btn-icon">&#9881;&#65039;</span><span>Settings</span></button>
        </div>
    </div>

    <!-- REWARD PICKER -->
    <div id="rewardPickerView" class="view">
        <div class="reward-picker-content">
            <div class="reward-picker-bear">&#129528;</div>
            <div class="reward-picker-title">Pick Your Reward!</div>
            <div class="reward-picker-subtitle">What do you want to work for today?</div>
            <div class="reward-options" id="rewardOptions"></div>
        </div>
    </div>

    <!-- STAR OVERLAY -->
    <div class="star-overlay" id="starOverlay"><div class="star-popup"><div class="big-star">&#11088;</div><div class="popup-text" id="popupText">Great job!</div><div class="popup-subtext" id="popupSubtext">+1 Star!</div></div></div>

    <!-- CELEBRATION -->
    <div id="celebrationView" class="view">
        <canvas class="confetti-canvas" id="confettiCanvas"></canvas>
        <div class="celebration-content">
            <div class="celebration-stars"><span>&#11088;</span><span>&#11088;</span><span>&#11088;</span><span>&#11088;</span><span>&#11088;</span></div>
            <div class="celebration-emoji">&#129395;</div>
            <div class="celebration-title">AMAZING!</div>
            <div class="celebration-subtitle">Paul earned all the stars!</div>
            <div class="celebration-reward" id="celebRewardEmoji">&#127851;</div>
            <div class="celebration-message" id="celebRewardMessage">Time for a sweet treat!</div>
            <button class="claim-btn" onclick="claimReward()">Claim Reward!</button>
        </div>
    </div>

    <!-- SETTINGS -->
    <div id="settingsView" class="view">
        <div class="settings-header"><div class="settings-title">&#9881;&#65039; Parent Settings</div><button class="settings-close-btn" onclick="closeSettings()">&#10005;</button></div>
        <div class="settings-scroll">
            <div class="settings-section"><div class="settings-section-title"><span class="icon">&#127851;</span> Reward Threshold</div><div class="threshold-display"><div class="threshold-value" id="thresholdDisplay">30</div><div class="threshold-label">stars needed for a reward</div></div><input type="range" class="threshold-slider" id="thresholdSlider" min="5" max="50" step="5" value="30" oninput="updateThreshold(this.value)"></div>
            <div class="settings-section"><div class="settings-section-title"><span class="icon">&#128266;</span> Sound</div><div class="toggle-row"><span class="toggle-label">Sound effects</span><button class="toggle-switch on" id="soundToggle" onclick="toggleSound()"></button></div></div>
            <div class="settings-section"><div class="settings-section-title"><span class="icon">&#128203;</span> Manage Tasks</div><div class="task-list-manage" id="taskListManage"></div>
                <div class="add-task-form">
                    <input type="text" class="emoji-input" id="newTaskEmoji" placeholder="&#128054;" readonly onclick="openEmojiPicker('newTaskEmoji')">
                    <input type="text" class="name-input" id="newTaskLabel" placeholder="Task name...">
                    <select class="points-select" id="newTaskPoints"><option value="1">1&#11088;</option><option value="2">2&#11088;</option><option value="3">3&#11088;</option><option value="4">4&#11088;</option><option value="5">5&#11088;</option></select>
                    <select class="cat-select" id="newTaskCat"><option value="morning">Morning</option><option value="afternoon">Afternoon</option><option value="evening">Evening</option></select>
                    <button class="add-task-btn" onclick="addNewTask()">Add</button>
                </div>
            </div>
            <div class="settings-section"><div class="settings-section-title"><span class="icon">&#127873;</span> Manage Rewards</div><div id="rewardListManage"></div>
                <div class="add-reward-form">
                    <input type="text" class="emoji-input" id="newRewardEmoji" placeholder="&#127873;" readonly onclick="openEmojiPicker('newRewardEmoji')">
                    <input type="text" class="name-input" id="newRewardName" placeholder="Reward name..." style="flex:1;min-width:0;padding:8px 10px;border:2px solid #e0d5c5;border-radius:10px;font-size:14px;font-family:inherit;outline:none">
                    <input type="text" id="newRewardDesc" placeholder="Short description..." style="flex:1;min-width:0;padding:8px 10px;border:2px solid #e0d5c5;border-radius:10px;font-size:12px;font-family:inherit;outline:none">
                    <button class="add-task-btn" onclick="addNewReward()">Add</button>
                </div>
            </div>
            <div class="settings-section"><div class="settings-section-title"><span class="icon">&#128260;</span> Reset</div><button class="reset-btn warning" onclick="resetStars()">Reset Stars to 0</button><button class="reset-btn danger" onclick="resetAll()">Reset Everything</button></div>
        </div>
    </div>

    <!-- HISTORY -->
    <div id="historyView" class="view">
        <div class="history-header"><div class="history-title">&#127942; Rewards</div><button class="history-close-btn" onclick="closeHistory()">&#10005;</button></div>
        <div class="history-scroll">
            <div class="history-stat"><div class="history-stat-number" id="historyTotalStars">0</div><div class="history-stat-label">Total Stars Earned</div></div>
            <div class="history-rewards"><div class="history-stat"><div class="history-stat-number" id="historyRewards">0</div><div class="history-stat-label">&#127851; Rewards Claimed</div></div><div class="history-stat"><div class="history-stat-number" id="historyTasks">0</div><div class="history-stat-label">&#9989; Tasks Done Today</div></div></div>
            <div class="history-stat"><div class="history-stat-number" id="historyStreak">0</div><div class="history-stat-label">&#128293; Day Streak</div></div>
        </div>
    </div>

    <!-- PARENT GATE -->
    <div class="parent-gate-overlay" id="parentGate">
        <div class="parent-gate-box"><div class="parent-gate-title">Parent Area</div><div class="parent-gate-subtitle">Hold the button for 3 seconds</div>
            <button class="hold-button" id="holdButton">&#128274;<svg class="hold-progress" viewBox="0 0 98 98"><circle class="bg" cx="49" cy="49" r="45"/><circle class="fg" id="holdProgressCircle" cx="49" cy="49" r="45"/></svg></button>
            <button class="parent-gate-cancel" onclick="closeParentGate()">Cancel</button>
        </div>
    </div>

    <!-- UNDO TOAST -->
    <div class="undo-toast" id="undoToast"><span id="undoText">Task completed</span><button class="undo-btn" onclick="undoLastTask()">Undo</button></div>

    <!-- EMOJI PICKER -->
    <div class="emoji-picker-overlay" id="emojiPickerOverlay">
        <div class="emoji-picker">
            <div class="emoji-picker-header"><div class="emoji-picker-header-title">Pick an Emoji</div><button class="emoji-picker-close" onclick="closeEmojiPicker()">&#10005;</button></div>
            <div class="emoji-categories" id="emojiCategories"></div>
            <div class="emoji-grid" id="emojiGrid"></div>
        </div>
    </div>

<script>
// ==================== EMOJI DATA ====================
const EMOJI_CATS = [
    { name:"Faces", icon:"\u{1F600}", emojis:"\u{1F600}\u{1F603}\u{1F604}\u{1F601}\u{1F606}\u{1F605}\u{1F602}\u{1F923}\u{1F60A}\u{1F607}\u{1F970}\u{1F60D}\u{1F929}\u{1F618}\u{1F617}\u{1F61A}\u{1F619}\u{1F972}\u{1F60B}\u{1F61B}\u{1F61C}\u{1F92A}\u{1F61D}\u{1F911}\u{1F917}\u{1F92D}\u{1F92B}\u{1F914}\u{1F910}\u{1F928}\u{1F610}\u{1F611}\u{1F636}\u{1F60F}\u{1F612}\u{1F644}\u{1F62C}\u{1F925}\u{1F60C}\u{1F614}\u{1F62A}\u{1F924}\u{1F634}\u{1F637}\u{1F912}\u{1F915}\u{1F922}\u{1F92E}\u{1F927}\u{1F975}\u{1F976}\u{1F974}\u{1F635}\u{1F920}\u{1F973}\u{1F978}\u{1F60E}\u{1F913}\u{1F9D0}" },
    { name:"People", icon:"\u{1F466}", emojis:"\u{1F466}\u{1F467}\u{1F468}\u{1F469}\u{1F474}\u{1F475}\u{1F476}\u{1F9D2}\u{1F9D3}\u{1F9D4}\u{1F478}\u{1F934}\u{1F936}\u{1F385}\u{1F9B8}\u{1F9B9}\u{1F9D9}\u{1F9DA}\u{1F9DB}\u{1F9DC}\u{1F9DD}\u{1F9DE}\u{1F9DF}\u{1F64D}\u{1F64E}\u{1F645}\u{1F646}\u{1F481}\u{1F64B}\u{1F647}\u{1F926}\u{1F937}\u{1F486}\u{1F487}\u{1F6B6}\u{1F3C3}\u{1F483}\u{1F57A}\u{1F9D6}\u{1F9D7}\u{1F9D8}\u{1F6C0}\u{1F6CC}\u{1F9CE}\u{1F9CF}\u{1F46B}\u{1F46D}\u{1F46C}\u{1F491}\u{1F48F}\u{1F46A}" },
    { name:"Animals", icon:"\u{1F43B}", emojis:"\u{1F435}\u{1F412}\u{1F98D}\u{1F9A7}\u{1F436}\u{1F415}\u{1F9AE}\u{1F429}\u{1F43A}\u{1F98A}\u{1F99D}\u{1F431}\u{1F408}\u{1F981}\u{1F42F}\u{1F405}\u{1F406}\u{1F434}\u{1F40E}\u{1F984}\u{1F993}\u{1F98C}\u{1F9AC}\u{1F42E}\u{1F402}\u{1F403}\u{1F404}\u{1F437}\u{1F416}\u{1F417}\u{1F43D}\u{1F40F}\u{1F411}\u{1F410}\u{1F42A}\u{1F42B}\u{1F999}\u{1F992}\u{1F418}\u{1F9A3}\u{1F98F}\u{1F99B}\u{1F42D}\u{1F401}\u{1F400}\u{1F439}\u{1F430}\u{1F407}\u{1F43F}\u{1F9AB}\u{1F994}\u{1F987}\u{1F43B}\u{1F428}\u{1F43C}\u{1F9A5}\u{1F9A6}\u{1F9A8}\u{1F998}\u{1F9A1}\u{1F43E}\u{1F983}\u{1F414}\u{1F413}\u{1F423}\u{1F424}\u{1F425}\u{1F426}\u{1F427}\u{1F54A}\u{1F985}\u{1F986}\u{1F9A2}\u{1F989}\u{1F9A4}\u{1FAB6}\u{1F9A9}\u{1F99A}\u{1F99C}\u{1F438}\u{1F40A}\u{1F422}\u{1F98E}\u{1F40D}\u{1F432}\u{1F409}\u{1F995}\u{1F996}\u{1F433}\u{1F40B}\u{1F42C}\u{1F9AD}\u{1F41F}\u{1F420}\u{1F421}\u{1F988}\u{1F419}\u{1F41A}\u{1F40C}\u{1F98B}\u{1F41B}\u{1F41C}\u{1F41D}\u{1FAB2}\u{1F41E}\u{1F997}\u{1FAB3}" },
    { name:"Food", icon:"\u{1F34E}", emojis:"\u{1F347}\u{1F348}\u{1F349}\u{1F34A}\u{1F34B}\u{1F34C}\u{1F34D}\u{1F96D}\u{1F34E}\u{1F34F}\u{1F350}\u{1F351}\u{1F352}\u{1F353}\u{1FAD0}\u{1F95D}\u{1F345}\u{1FAD2}\u{1F965}\u{1F951}\u{1F346}\u{1F954}\u{1F955}\u{1F33D}\u{1F336}\u{1FAD1}\u{1F952}\u{1F96C}\u{1F966}\u{1F9C4}\u{1F9C5}\u{1F344}\u{1F95C}\u{1F330}\u{1F35E}\u{1F950}\u{1F956}\u{1FAD3}\u{1F968}\u{1F96F}\u{1F95E}\u{1F9C7}\u{1F9C0}\u{1F356}\u{1F357}\u{1F969}\u{1F953}\u{1F354}\u{1F35F}\u{1F355}\u{1F32D}\u{1F96A}\u{1F32E}\u{1F32F}\u{1FAD4}\u{1F959}\u{1F9C6}\u{1F95A}\u{1F373}\u{1F958}\u{1F372}\u{1FAD5}\u{1F963}\u{1F957}\u{1F37F}\u{1F9C8}\u{1F9C2}\u{1F96B}\u{1F371}\u{1F358}\u{1F359}\u{1F35A}\u{1F35B}\u{1F35C}\u{1F35D}\u{1F360}\u{1F362}\u{1F363}\u{1F364}\u{1F365}\u{1F96E}\u{1F361}\u{1F95F}\u{1F960}\u{1F961}\u{1F980}\u{1F99E}\u{1F990}\u{1F991}\u{1F9AA}\u{1F366}\u{1F367}\u{1F368}\u{1F369}\u{1F36A}\u{1F382}\u{1F370}\u{1F9C1}\u{1F967}\u{1F36B}\u{1F36C}\u{1F36D}\u{1F36E}\u{1F36F}" },
    { name:"Sports", icon:"\u26BD", emojis:"\u26BD\u{1F3C0}\u{1F3C8}\u26BE\u{1F94E}\u{1F3BE}\u{1F3D0}\u{1F3C9}\u{1F94F}\u{1F3B1}\u{1F3D3}\u{1F3F8}\u{1F3D2}\u{1F3D1}\u{1F94D}\u{1F3CF}\u{1F945}\u26F3\u{1F3A3}\u{1F93F}\u{1F3BD}\u{1F3BF}\u26F7\u{1F6F7}\u{1F3C2}\u26F8\u{1F94C}\u{1F3CB}\u{1F93C}\u{1F938}\u{1F93A}\u{1F93E}\u26F9\u{1F3C4}\u{1F3CA}\u{1F93D}\u{1F6A3}\u{1F9D7}\u{1F6B5}\u{1F6B4}\u{1F3C7}\u{1F3C6}\u{1F3C5}\u{1F396}\u{1F947}\u{1F948}\u{1F949}" },
    { name:"Things", icon:"\u{1F3E0}", emojis:"\u{1F3E0}\u{1F3EB}\u{1F3E5}\u{1F3E2}\u{1F3ED}\u{1F3F0}\u{1F492}\u{1F5FC}\u{1F6D5}\u26EA\u{1F54C}\u{1F54D}\u{1F54B}\u26E9\u{1F6D6}\u{1F6D2}\u{1F697}\u{1F695}\u{1F699}\u{1F68C}\u{1F3CE}\u{1F691}\u{1F692}\u{1F693}\u{1F6B2}\u{1F6F4}\u{1F6F9}\u{1F6F5}\u{1F6BA}\u{1F6B0}\u{1F3A8}\u{1F3AD}\u{1F3A4}\u{1F3A7}\u{1F3B5}\u{1F3B6}\u{1F3B9}\u{1F941}\u{1F3B7}\u{1F3BA}\u{1F3B8}\u{1FA95}\u{1F3BB}\u{1FA98}\u{1FA97}\u{1F4FA}\u{1F4F7}\u{1F4F9}\u{1F4F1}\u{1F4BB}\u2328\u{1F5A8}\u{1F4A1}\u{1F526}\u{1F56F}\u{1F4DA}\u{1F4D6}\u{1F4D3}\u{1F4DD}\u270F\u{1F4CF}\u{1F4D0}\u{1F527}\u{1F528}\u{1F6E0}\u{1F9F0}\u{1FA9A}\u{1FA9B}\u{1F9F2}\u{1F9F9}\u{1F9FA}\u{1F9FB}\u{1FAA3}\u{1F9FC}\u{1FAA5}\u{1F6BF}\u{1F6C1}\u{1FA92}\u{1FA91}\u{1F6CF}\u{1F6CB}" },
    { name:"Nature", icon:"\u{1F33B}", emojis:"\u{1F490}\u{1F338}\u{1F4AE}\u{1F3F5}\u{1F339}\u{1F940}\u{1F33A}\u{1F33B}\u{1F33C}\u{1F337}\u{1F331}\u{1FAB4}\u{1F332}\u{1F333}\u{1F334}\u{1F335}\u{1F33E}\u{1F33F}\u2618\u{1F340}\u{1F341}\u{1F342}\u{1F343}\u{1F344}\u{1FAB8}\u{1F30D}\u{1F30E}\u{1F30F}\u{1F315}\u{1F319}\u2B50\u{1F31F}\u{1F320}\u2601\u{1F324}\u26C5\u{1F325}\u{1F326}\u{1F327}\u26C8\u{1F308}\u2744\u{1F525}\u{1F4A7}\u{1F30A}" },
    { name:"Symbols", icon:"\u2764", emojis:"\u2764\u{1F9E1}\u{1F49B}\u{1F49A}\u{1F499}\u{1F49C}\u{1F5A4}\u{1FA76}\u{1F90D}\u{1F90E}\u{1F498}\u{1F49D}\u{1F496}\u{1F497}\u{1F493}\u{1F49E}\u{1F495}\u{1F48C}\u{1F4AF}\u{1F4A2}\u{1F4A5}\u{1F4AB}\u{1F4A6}\u{1F573}\u{1F4A3}\u{1F4AC}\u{1F441}\u200D\u{1F5E8}\u{1F5E8}\u{1F4AD}\u{1F4A4}\u{1F44B}\u{1F91A}\u{1F590}\u270B\u{1F596}\u{1F44C}\u{1F90C}\u{1F90F}\u270C\u{1F91E}\u{1F91F}\u{1F918}\u{1F919}\u{1F448}\u{1F449}\u{1F446}\u{1F447}\u261D\u{1F44D}\u{1F44E}\u270A\u{1F44A}\u{1F91B}\u{1F91C}\u{1F44F}\u{1F64C}\u{1F450}\u{1F932}\u{1F91D}\u{1F64F}" }
];

// ==================== DEFAULT TASKS ====================
const DEFAULT_TASKS = [
    { label:"Brush teeth", emoji:"\u{1FAA5}", cat:"morning", points:1 },
    { label:"Wash face", emoji:"\u{1F4A6}", cat:"morning", points:1 },
    { label:"Get dressed", emoji:"\u{1F455}", cat:"morning", points:1 },
    { label:"Comb hair", emoji:"\u{1F487}", cat:"morning", points:1 },
    { label:"Make the bed", emoji:"\u{1F6CF}\uFE0F", cat:"morning", points:2 },
    { label:"Eat breakfast", emoji:"\u{1F95E}", cat:"morning", points:1 },
    { label:"Wash hands", emoji:"\u{1F9FC}", cat:"morning", points:1 },
    { label:"Put on shoes", emoji:"\u{1F45F}", cat:"morning", points:1 },
    { label:"Take a bath", emoji:"\u{1F6C1}", cat:"evening", points:2 },
    { label:"Use tissue", emoji:"\u{1F927}", cat:"afternoon", points:1 },
    { label:"Use toilet", emoji:"\u{1F6BD}", cat:"afternoon", points:1 },
    { label:"Wear pyjamas", emoji:"\u{1F319}", cat:"evening", points:1 },
    { label:"Pick up toys", emoji:"\u{1F9F8}", cat:"afternoon", points:2 },
    { label:"Dirty clothes in basket", emoji:"\u{1F9FA}", cat:"afternoon", points:1 },
    { label:"Help set table", emoji:"\u{1F37D}\uFE0F", cat:"afternoon", points:2 },
    { label:"Help clear table", emoji:"\u{1F959}", cat:"evening", points:2 },
    { label:"Put books away", emoji:"\u{1F4DA}", cat:"evening", points:1 },
    { label:"Help carry bags", emoji:"\u{1F6CD}\uFE0F", cat:"afternoon", points:2 },
    { label:"Eat veggies", emoji:"\u{1F966}", cat:"afternoon", points:3 },
    { label:"Drink water", emoji:"\u{1F4A7}", cat:"afternoon", points:1 },
    { label:"Eat nicely", emoji:"\u{1F60B}", cat:"afternoon", points:2 },
    { label:"Try new food", emoji:"\u{1F372}", cat:"afternoon", points:3 },
    { label:"Say please & thanks", emoji:"\u{1F64F}", cat:"afternoon", points:1 },
    { label:"Share with others", emoji:"\u{1F91D}", cat:"afternoon", points:2 },
    { label:"Be gentle", emoji:"\u{1F49B}", cat:"afternoon", points:1 },
    { label:"Listen to Mum & Dad", emoji:"\u{1F442}", cat:"afternoon", points:2 },
    { label:"Stay calm", emoji:"\u{1F60A}", cat:"afternoon", points:2 },
    { label:"Read a book", emoji:"\u{1F4D6}", cat:"evening", points:2 },
    { label:"Draw a picture", emoji:"\u{1F3A8}", cat:"afternoon", points:1 },
    { label:"Go to bed on time", emoji:"\u{1F634}", cat:"evening", points:3 }
];

const DEFAULT_REWARDS = [
    { id:"chocolate", emoji:"\u{1F36B}", name:"Chocolate", desc:"A yummy sweet treat!", message:"Time for chocolate!" },
    { id:"tv", emoji:"\u{1F4FA}", name:"10 min TV", desc:"Watch your favourite show!", message:"Time for TV!" },
    { id:"cuddle", emoji:"\u{1F917}", name:"Cuddle with Mama", desc:"Big warm cuddle time!", message:"Time for a big cuddle!" },
    { id:"trampoline", emoji:"\u{1F938}", name:"Trampoline!", desc:"Jump jump jump!", message:"Time to jump!" },
    { id:"book", emoji:"\u{1F4D6}", name:"Story Time", desc:"Mama or Dad reads a book!", message:"Time for a story!" }
];

const PRAISE_WORDS = ["Great job!","Super!","Awesome!","Yay!","Fantastic!","Well done!","Brilliant!","You rock!","Star!","Amazing!","Way to go!","Superstar!","Wonderful!","Hooray!","Terrific!"];
const CAT_ORDER = ["morning","afternoon","evening"];
const CAT_LABELS = { morning:"\u{2600}\uFE0F Morning", afternoon:"\u{1F31E} Afternoon", evening:"\u{1F319} Evening" };
const MILESTONE_STARS = [5,10,15,20,25,30,35,40,45,50];

// ==================== STATE ====================
const STORAGE_KEY = "paulBearStarApp";
let state = loadState();
let lastCompletedTaskId = null;
let undoTimer = null;
let audioContext = null;
let emojiPickerTarget = null;

function getDefaultState() {
    return {
        version:"2.0", stars:0, targetStars:30, totalStarsEarned:0, totalRewardsEarned:0,
        soundEnabled:true, selectedRewardId:null, streak:0, lastActiveDate:null,
        rewards: DEFAULT_REWARDS.map(r => ({...r})),
        tasks: DEFAULT_TASKS.map((t,i) => ({ id:"task-"+String(i+1).padStart(3,"0"), label:t.label, emoji:t.emoji, completed:false, cat:t.cat, points:t.points }))
    };
}

function loadState() {
    try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            const p = JSON.parse(saved);
            if (!p.tasks) return getDefaultState();
            // migrate
            if (!p.rewards) p.rewards = DEFAULT_REWARDS.map(r => ({...r}));
            if (!p.streak && p.streak !== 0) p.streak = 0;
            if (!p.lastActiveDate) p.lastActiveDate = null;
            if (p.totalStarsEarned === undefined) p.totalStarsEarned = 0;
            if (p.totalRewardsEarned === undefined) p.totalRewardsEarned = 0;
            if (p.soundEnabled === undefined) p.soundEnabled = true;
            if (p.selectedRewardId === undefined) p.selectedRewardId = null;
            // migrate tasks: add cat/points if missing
            p.tasks.forEach((t,i) => {
                if (!t.cat) t.cat = DEFAULT_TASKS[i] ? DEFAULT_TASKS[i].cat : "afternoon";
                if (!t.points) t.points = 1;
            });
            return p;
        }
    } catch(e) { console.warn("Load error:",e); }
    return getDefaultState();
}

function saveState() { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch(e) {} }

// ==================== STREAK ====================
function updateStreak() {
    const today = new Date().toISOString().slice(0,10);
    if (state.lastActiveDate === today) return;
    if (state.lastActiveDate) {
        const last = new Date(state.lastActiveDate);
        const now = new Date(today);
        const diff = Math.floor((now - last) / 86400000);
        if (diff === 1) { state.streak++; } else if (diff > 1) { state.streak = 1; }
    } else { state.streak = 1; }
    state.lastActiveDate = today;
    saveState();
}

// ==================== SOUND ====================
function ensureAudio() {
    if (!audioContext) {
        try { audioContext = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) { return; }
    }
    if (audioContext.state === "suspended") audioContext.resume();
}

function playNote(freq, dur, type, time, vol) {
    if (!audioContext || !state.soundEnabled) return;
    ensureAudio();
    const o = audioContext.createOscillator(), g = audioContext.createGain();
    o.type = type||"sine"; o.frequency.setValueAtTime(freq, time);
    g.gain.setValueAtTime(vol||0.2, time); g.gain.exponentialRampToValueAtTime(0.001, time+dur);
    o.connect(g); g.connect(audioContext.destination); o.start(time); o.stop(time+dur);
}

function playTaskCompleteSound() {
    if (!audioContext || !state.soundEnabled) return;
    ensureAudio();
    const n = audioContext.currentTime;
    playNote(523,0.15,"triangle",n,0.25); playNote(659,0.15,"triangle",n+0.08,0.25);
    playNote(784,0.2,"triangle",n+0.16,0.25); playNote(1047,0.3,"sine",n+0.24,0.2);
}

function playUndoSound() {
    if (!audioContext || !state.soundEnabled) return;
    ensureAudio();
    const n = audioContext.currentTime;
    playNote(784,0.15,"triangle",n,0.2); playNote(523,0.2,"triangle",n+0.1,0.2);
}

function playCelebrationSound() {
    if (!audioContext || !state.soundEnabled) return;
    ensureAudio();
    const n = audioContext.currentTime;
    [[523,0.2,0],[523,0.15,0.2],[523,0.15,0.35],[659,0.2,0.5],[784,0.3,0.7],[1047,0.5,1.0],[988,0.15,1.3],[1047,0.6,1.5]].forEach(([f,d,t]) => {
        playNote(f,d,"square",n+t,0.15); playNote(f*1.5,d,"sine",n+t,0.08);
    });
}

function speakGerman() {
    if (!state.soundEnabled) return;
    if ('speechSynthesis' in window) {
        const u = new SpeechSynthesisUtterance("Das machst du super, Paul! Weiter so!");
        u.lang = "de-DE"; u.rate = 0.9; u.pitch = 1.1; u.volume = 1;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
    }
}

// ==================== CONFETTI ====================
let confettiParticles = [], confettiFrame = null;
function startConfetti() {
    const c = document.getElementById("confettiCanvas"); c.width = window.innerWidth; c.height = window.innerHeight;
    const ctx = c.getContext("2d"), colors = ["#FF6B6B","#4ECDC4","#FFE66D","#FF8C42","#A8E6CF","#FF69B4","#7B68EE","#FFD700"];
    confettiParticles = [];
    for (let i=0;i<120;i++) confettiParticles.push({ x:Math.random()*c.width, y:Math.random()*c.height-c.height, vx:(Math.random()-0.5)*4, vy:Math.random()*3+1.5, size:Math.random()*8+4, color:colors[Math.floor(Math.random()*colors.length)], rot:Math.random()*360, rs:(Math.random()-0.5)*8, shape:Math.random()>0.5?"r":"c" });
    function anim() {
        ctx.clearRect(0,0,c.width,c.height);
        confettiParticles.forEach(p => {
            p.x+=p.vx; p.y+=p.vy; p.vy+=0.04; p.rot+=p.rs;
            if(p.y>c.height+20){p.y=-10;p.x=Math.random()*c.width;p.vy=Math.random()*3+1.5;}
            ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot*Math.PI/180); ctx.fillStyle=p.color;
            if(p.shape==="r") ctx.fillRect(-p.size/2,-p.size/4,p.size,p.size/2); else { ctx.beginPath(); ctx.arc(0,0,p.size/2,0,Math.PI*2); ctx.fill(); }
            ctx.restore();
        });
        confettiFrame = requestAnimationFrame(anim);
    }
    anim();
}
function stopConfetti() { if(confettiFrame){cancelAnimationFrame(confettiFrame);confettiFrame=null;} confettiParticles=[]; const c=document.getElementById("confettiCanvas"); c.getContext("2d").clearRect(0,0,c.width,c.height); }

// ==================== VIEWS ====================
function showView(id) { document.querySelectorAll(".view").forEach(v=>v.classList.remove("active")); document.getElementById(id).classList.add("active"); }

// ==================== RENDER ====================
function render() {
    document.getElementById("starCount").textContent = state.stars;
    document.getElementById("starTarget").textContent = "/ " + state.targetStars;
    const progress = Math.min((state.stars/state.targetStars)*100,100);
    document.getElementById("progressFill").style.width = progress+"%";
    const reward = getSelectedReward();
    const rem = state.targetStars - state.stars;
    document.getElementById("progressText").textContent = rem > 0 ? rem+" more star"+(rem!==1?"s":"")+" to earn" : "Ready to claim";
    document.getElementById("progressRewardIcon").textContent = reward.emoji;
    document.getElementById("badgeEmoji").textContent = reward.emoji;
    document.getElementById("badgeLabel").textContent = reward.name;

    // Streak
    const sb = document.getElementById("streakBadge");
    if (state.streak > 1) { sb.style.display = "inline-flex"; document.getElementById("streakCount").textContent = state.streak; } else { sb.style.display = "none"; }

    renderTaskGrid();
    document.getElementById("thresholdDisplay").textContent = state.targetStars;
    document.getElementById("thresholdSlider").value = state.targetStars;
    document.getElementById("soundToggle").classList.toggle("on", state.soundEnabled);
    document.getElementById("historyTotalStars").textContent = state.totalStarsEarned;
    document.getElementById("historyRewards").textContent = state.totalRewardsEarned;
    document.getElementById("historyTasks").textContent = state.tasks.filter(t=>t.completed).length;
    document.getElementById("historyStreak").textContent = state.streak;
}

function renderTaskGrid() {
    const container = document.getElementById("taskGridContainer");
    container.innerHTML = "";
    CAT_ORDER.forEach(cat => {
        const tasks = state.tasks.filter(t => t.cat === cat);
        if (tasks.length === 0) return;
        const header = document.createElement("div");
        header.className = "category-header " + cat;
        header.textContent = CAT_LABELS[cat];
        container.appendChild(header);
        const grid = document.createElement("div");
        grid.className = "task-grid";
        tasks.forEach(task => {
            const card = document.createElement("div");
            card.className = "task-card" + (task.completed ? " completed" : "");
            const pts = task.points > 1 ? task.points + "\u2B50" : "";
            card.innerHTML = '<div class="task-check">\u2713</div><div class="task-emoji">'+task.emoji+'</div><div class="task-label">'+escapeHtml(task.label)+'</div>' + (pts ? '<div class="task-points">'+pts+'</div>' : '');
            card.addEventListener("click", () => { ensureAudio(); task.completed ? uncompleteTask(task.id) : completeTask(task.id); });
            grid.appendChild(card);
        });
        container.appendChild(grid);
    });
}

function renderTaskManageList() {
    const list = document.getElementById("taskListManage"); list.innerHTML = "";
    state.tasks.forEach(task => {
        const item = document.createElement("div"); item.className = "task-manage-item";
        item.innerHTML = '<div class="task-manage-emoji" data-id="'+task.id+'">'+task.emoji+'</div><div class="task-manage-label">'+escapeHtml(task.label)+'</div><div class="task-manage-points">'+task.points+'\u2B50</div><div class="task-manage-cat">'+task.cat+'</div><button class="task-manage-delete" data-id="'+task.id+'">\u2715</button>';
        item.querySelector(".task-manage-emoji").addEventListener("click", () => { openEmojiPicker("taskEmoji_"+task.id); });
        item.querySelector(".task-manage-delete").addEventListener("click", e => { e.stopPropagation(); deleteTask(task.id); });
        list.appendChild(item);
    });
}

function renderRewardManageList() {
    const list = document.getElementById("rewardListManage"); list.innerHTML = "";
    state.rewards.forEach(r => {
        const item = document.createElement("div"); item.className = "reward-manage-item";
        item.innerHTML = '<div class="reward-manage-emoji" data-id="'+r.id+'">'+r.emoji+'</div><div class="reward-manage-label">'+escapeHtml(r.name)+'</div><button class="reward-manage-delete" data-id="'+r.id+'">\u2715</button>';
        item.querySelector(".reward-manage-emoji").addEventListener("click", () => { openEmojiPicker("rewardEmoji_"+r.id); });
        item.querySelector(".reward-manage-delete").addEventListener("click", e => { e.stopPropagation(); deleteReward(r.id); });
        list.appendChild(item);
    });
}

function escapeHtml(t) { const d=document.createElement("div"); d.textContent=t; return d.innerHTML; }

// ==================== REWARD PICKER ====================
function getSelectedReward() {
    if (state.selectedRewardId) { const f = state.rewards.find(r=>r.id===state.selectedRewardId); if(f) return f; }
    return state.rewards[0] || DEFAULT_REWARDS[0];
}

function showRewardPicker() { ensureAudio(); renderRewardOptions(); showView("rewardPickerView"); }

function renderRewardOptions() {
    const c = document.getElementById("rewardOptions"); c.innerHTML = "";
    state.rewards.forEach(r => {
        const o = document.createElement("div"); o.className = "reward-option"+(state.selectedRewardId===r.id?" selected":"");
        o.innerHTML = '<div class="reward-option-emoji">'+r.emoji+'</div><div class="reward-option-info"><div class="reward-option-name">'+escapeHtml(r.name)+'</div><div class="reward-option-desc">'+escapeHtml(r.desc||"")+'</div></div>';
        o.addEventListener("click", ()=>selectReward(r.id));
        c.appendChild(o);
    });
}

function selectReward(id) { state.selectedRewardId=id; saveState(); playTaskCompleteSound(); renderRewardOptions(); setTimeout(()=>{showView("mainView");render();},300); }

// ==================== TASKS ====================
function completeTask(taskId) {
    const task = state.tasks.find(t=>t.id===taskId);
    if (!task || task.completed) return;
    task.completed = true;
    state.stars += task.points;
    state.totalStarsEarned += task.points;
    updateStreak();
    saveState();
    lastCompletedTaskId = taskId;
    showStarPopup(task);

    // Milestone check
    if (MILESTONE_STARS.includes(state.stars) && state.stars < state.targetStars) {
        setTimeout(speakGerman, 800);
    }

    if (state.stars >= state.targetStars) { setTimeout(showCelebration, 1200); }
    else { showUndoToast(task.label); }
}

function uncompleteTask(taskId) {
    const task = state.tasks.find(t=>t.id===taskId);
    if (!task || !task.completed) return;
    task.completed = false;
    state.stars = Math.max(0, state.stars - task.points);
    state.totalStarsEarned = Math.max(0, state.totalStarsEarned - task.points);
    saveState();
    playUndoSound();
    render();
    showUndoToast(task.label + " undone");
}

function showStarPopup(task) {
    const overlay = document.getElementById("starOverlay");
    document.getElementById("popupText").textContent = PRAISE_WORDS[Math.floor(Math.random()*PRAISE_WORDS.length)];
    document.getElementById("popupSubtext").textContent = "+" + task.points + " Star"+(task.points>1?"s":"")+"! ("+state.stars+"/"+state.targetStars+")";
    overlay.classList.add("active");
    playTaskCompleteSound();
    render();
    setTimeout(()=>overlay.classList.remove("active"), 1100);
}

function showUndoToast(text) {
    clearTimeout(undoTimer);
    document.getElementById("undoText").textContent = text;
    document.getElementById("undoToast").classList.add("active");
    undoTimer = setTimeout(()=>{ document.getElementById("undoToast").classList.remove("active"); lastCompletedTaskId=null; }, 4000);
}

function undoLastTask() {
    if (!lastCompletedTaskId) return;
    const task = state.tasks.find(t=>t.id===lastCompletedTaskId);
    if (task && task.completed) { uncompleteTask(task.id); }
    clearTimeout(undoTimer);
    document.getElementById("undoToast").classList.remove("active");
    lastCompletedTaskId = null;
}

// ==================== CELEBRATION ====================
function showCelebration() {
    const r = getSelectedReward();
    document.getElementById("celebRewardEmoji").textContent = r.emoji;
    document.getElementById("celebRewardMessage").textContent = r.message;
    showView("celebrationView"); startConfetti(); playCelebrationSound();
    setTimeout(speakGerman, 500);
    document.getElementById("bearAvatar").classList.add("celebrating");
}

function claimReward() {
    state.totalRewardsEarned++; state.stars=0; state.selectedRewardId=null;
    state.tasks.forEach(t=>t.completed=false); saveState();
    stopConfetti(); document.getElementById("bearAvatar").classList.remove("celebrating");
    showRewardPicker();
}

// ==================== NEW DAY ====================
function resetToday() {
    if (state.tasks.every(t=>!t.completed)) return;
    state.tasks.forEach(t=>t.completed=false); saveState(); render();
}

// ==================== PARENT GATE ====================
let holdTimer=null, holdStartTime=0, holdAnimFrame=null;
function showParentGate() { document.getElementById("parentGate").classList.add("active"); setupHoldButton(); }
function closeParentGate() { document.getElementById("parentGate").classList.remove("active"); cancelHold(); }

function setupHoldButton() {
    const btn=document.getElementById("holdButton"), circle=document.getElementById("holdProgressCircle");
    const circ=2*Math.PI*45;
    circle.style.strokeDasharray=circ; circle.style.strokeDashoffset=circ;
    function start(e) { e.preventDefault(); holdStartTime=Date.now(); circle.style.transition="none"; circle.style.strokeDashoffset=circ; animH();
        holdTimer=setTimeout(()=>{cancelAnimationFrame(holdAnimFrame);closeParentGate();openSettings();},3000);
    }
    function animH() { const p=Math.min((Date.now()-holdStartTime)/3000,1); circle.style.strokeDashoffset=circ*(1-p); if(p<1) holdAnimFrame=requestAnimationFrame(animH); }
    function end(e) { e.preventDefault(); cancelHold(); }
    ["touchstart","mousedown"].forEach(ev=>btn.removeEventListener(ev,start));
    ["touchend","mouseup","touchcancel","mouseleave"].forEach(ev=>btn.removeEventListener(ev,end));
    btn.addEventListener("touchstart",start,{passive:false}); btn.addEventListener("mousedown",start);
    btn.addEventListener("touchend",end,{passive:false}); btn.addEventListener("mouseup",end);
    btn.addEventListener("touchcancel",end,{passive:false}); btn.addEventListener("mouseleave",end);
}
function cancelHold() { clearTimeout(holdTimer); cancelAnimationFrame(holdAnimFrame); const c=document.getElementById("holdProgressCircle"); c.style.strokeDashoffset=2*Math.PI*45; }

// ==================== SETTINGS ====================
function openSettings() { renderTaskManageList(); renderRewardManageList(); showView("settingsView"); }
function closeSettings() { showView("mainView"); render(); }
function updateThreshold(v) { state.targetStars=parseInt(v); document.getElementById("thresholdDisplay").textContent=v; saveState(); }
function toggleSound() { state.soundEnabled=!state.soundEnabled; saveState(); document.getElementById("soundToggle").classList.toggle("on",state.soundEnabled); if(state.soundEnabled){ensureAudio();playTaskCompleteSound();} }

function addNewTask() {
    const emoji=document.getElementById("newTaskEmoji").value.trim()||"\u2B50";
    const label=document.getElementById("newTaskLabel").value.trim();
    if(!label){document.getElementById("newTaskLabel").focus();return;}
    const points=parseInt(document.getElementById("newTaskPoints").value)||1;
    const cat=document.getElementById("newTaskCat").value||"afternoon";
    state.tasks.push({id:"task-"+Date.now(),label,emoji,completed:false,cat,points});
    saveState(); renderTaskManageList();
    document.getElementById("newTaskEmoji").value=""; document.getElementById("newTaskLabel").value="";
}

function deleteTask(id) { state.tasks=state.tasks.filter(t=>t.id!==id); saveState(); renderTaskManageList(); }

function addNewReward() {
    const emoji=document.getElementById("newRewardEmoji").value.trim()||"\u{1F381}";
    const name=document.getElementById("newRewardName").value.trim();
    if(!name){document.getElementById("newRewardName").focus();return;}
    const desc=document.getElementById("newRewardDesc").value.trim();
    state.rewards.push({id:"reward-"+Date.now(),emoji,name,desc,message:"Time for "+name+"!"});
    saveState(); renderRewardManageList();
    document.getElementById("newRewardEmoji").value=""; document.getElementById("newRewardName").value=""; document.getElementById("newRewardDesc").value="";
}

function deleteReward(id) { state.rewards=state.rewards.filter(r=>r.id!==id); if(state.selectedRewardId===id) state.selectedRewardId=null; saveState(); renderRewardManageList(); }

function resetStars() { if(confirm("Reset Paul's stars to 0?")){state.stars=0;state.tasks.forEach(t=>t.completed=false);saveState();render();} }
function resetAll() { if(confirm("This will delete ALL data. Are you sure?")){state=getDefaultState();saveState();render();renderTaskManageList();renderRewardManageList();closeSettings();showRewardPicker();} }

// ==================== HISTORY ====================
function showHistory() { render(); showView("historyView"); }
function closeHistory() { showView("mainView"); }

// ==================== EMOJI PICKER ====================
function openEmojiPicker(target) {
    emojiPickerTarget = target;
    renderEmojiPicker(0);
    document.getElementById("emojiPickerOverlay").classList.add("active");
}
function closeEmojiPicker() { document.getElementById("emojiPickerOverlay").classList.remove("active"); emojiPickerTarget=null; }

function renderEmojiPicker(catIndex) {
    const cats = document.getElementById("emojiCategories"); cats.innerHTML = "";
    EMOJI_CATS.forEach((c,i) => {
        const b = document.createElement("button"); b.className = "emoji-cat-btn"+(i===catIndex?" active":"");
        b.textContent = c.icon;
        b.addEventListener("click", ()=>renderEmojiPicker(i));
        cats.appendChild(b);
    });
    const grid = document.getElementById("emojiGrid"); grid.innerHTML = "";
    const emojis = [...EMOJI_CATS[catIndex].emojis];
    emojis.forEach(em => {
        const item = document.createElement("div"); item.className = "emoji-grid-item";
        item.textContent = em;
        item.addEventListener("click", ()=>selectEmoji(em));
        grid.appendChild(item);
    });
}

function selectEmoji(emoji) {
    if (!emojiPickerTarget) return;
    if (emojiPickerTarget === "newTaskEmoji" || emojiPickerTarget === "newRewardEmoji") {
        document.getElementById(emojiPickerTarget).value = emoji;
    } else if (emojiPickerTarget.startsWith("taskEmoji_")) {
        const taskId = emojiPickerTarget.replace("taskEmoji_","");
        const task = state.tasks.find(t=>t.id===taskId);
        if (task) { task.emoji = emoji; saveState(); renderTaskManageList(); }
    } else if (emojiPickerTarget.startsWith("rewardEmoji_")) {
        const rewardId = emojiPickerTarget.replace("rewardEmoji_","");
        const reward = state.rewards.find(r=>r.id===rewardId);
        if (reward) { reward.emoji = emoji; saveState(); renderRewardManageList(); }
    }
    closeEmojiPicker();
}

// ==================== INIT ====================
function init() {
    render();
    if (!state.selectedRewardId) showRewardPicker();
    document.addEventListener("touchstart", ()=>ensureAudio(), {once:true});
    document.addEventListener("click", ()=>ensureAudio(), {once:true});
    window.addEventListener("resize", ()=>{ const c=document.getElementById("confettiCanvas"); if(c&&confettiFrame){c.width=window.innerWidth;c.height=window.innerHeight;} });
}

if ("serviceWorker" in navigator) { navigator.serviceWorker.register("sw.js").catch(()=>{}); }
init();
</script>
</body>
</html>
